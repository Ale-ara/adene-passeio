<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADENE ‚Ä¢ Lista Caf√© da Comunh√£o</title>

<style>
/* ============================================= */
/* ================ TEMA GLOBAL ================= */
/* ============================================= */
:root{
  --bg:#070707;
  --card:#0f0f10;
  --primary:#025E15;      /* sua cor base */
  --primary-2:#038A28;    /* varia√ß√£o para gradiente */
  --primary-3:#04A634;    /* tom mais claro para destaque */
  --muted:#9aa29a;
  --white:#ffffff;
  --glass: rgba(255,255,255,0.03);
  --accent-shadow: 0 18px 60px rgba(2,94,21,0.12);
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--white);
  -webkit-font-smoothing:antialiased;
}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* ============================================= */
/* ================ LOADING SCREEN ============= */
/* ============================================= */
#loadingScreen {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: #000000e6;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:20px;
  z-index:3000;
  animation: fadeOut 0.8s ease 1.2s forwards;
}

#loadingLogo {
  width:90px;
  height:90px;
  border-radius:12px;
  overflow:hidden;
  border:2px solid var(--primary-3);
  box-shadow:0 0 25px rgba(2,94,21,0.45);
}

#loadingLogo img {
  width:100%; height:100%; object-fit:cover;
}

.loadingText {
  color:var(--primary-3);
  font-size:18px;
  font-weight:600;
}

.spinner {
  width:46px;
  height:46px;
  border:4px solid #ffffff18;
  border-top:4px solid var(--primary-3);
  border-radius:50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform:rotate(360deg); }
}

@keyframes fadeOut {
  to {
    opacity:0;
    visibility:hidden;
  }
}

/* ============================================= */
/* ================= HEADER ==================== */
/* ============================================= */
.header {
  position:fixed;left:0;right:0;top:0;height:76px;
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  background:linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.30));
  border-bottom:1px solid rgba(255,255,255,0.02);
  z-index:1000;
}
.brand {
  display:flex;gap:12px;align-items:center;
}
.brand .logo{
  width:56px;height:56px;border-radius:10px;background:#000;display:flex;align-items:center;justify-content:center;
  overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6)
}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.header .title{font-size:16px;font-weight:700}
.header .subtitle{font-size:12px;color:var(--muted)}

.main {padding-top:98px;padding-left:12px;padding-right:12px}

/* ============================================= */
/* ================ CARD LIST ================== */
/* ============================================= */

.section-title{font-weight:700;margin:18px 0 8px 0;color:var(--primary-3);font-size:14px}
.small{font-size:12px;color:var(--muted)}

.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:12px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);
  display:flex;justify-content:space-between;align-items:center;gap:12px;
}
.card .left{display:flex;flex-direction:column;gap:6px;min-width:0}
.card .item{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card .qty{color:var(--muted);font-size:13px}
.card .who{color:var(--primary-3);font-weight:700}
.btn-small{
  background: linear-gradient(90deg,var(--primary),var(--primary-2));
  color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--accent-shadow)
}
.btn-small.ghost{
  background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);
}

/* ============================================= */
/* ================ BOT BUTTON ================= */
/* ============================================= */
.bot-btn{
  position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:999px;
  background:linear-gradient(90deg,var(--primary-3),var(--primary-2));
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--accent-shadow);z-index:2000;font-weight:900;color:#fff;font-size:22px;cursor:pointer;
  border:1px solid rgba(255,255,255,0.04);
}

/* ============================================= */
/* ================ CHAT PANEL ================= */
/* ============================================= */
.chat-panel{
  position:fixed;right:8px;bottom:92px;left:8px;border-radius:14px;
  background:linear-gradient(180deg, rgba(0,0,0,0.90), rgba(0,0,0,0.98));
  border:1px solid rgba(255,255,255,0.04);z-index:2100;max-height:80vh;
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:0 20px 70px rgba(0,0,0,0.6);
}
.chat-panel.hidden{display:none}
.chat-header{padding:14px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;gap:12px}
.chat-body{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:10px}
.chat-footer{padding:10px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center}
.msg{max-width:78%;padding:10px 12px;border-radius:12px}
.msg.bot{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));align-self:flex-start;color:var(--white);border:1px solid rgba(255,255,255,0.02)}
.msg.user{background:linear-gradient(90deg, rgba(2,94,21,0.10), rgba(3,138,40,0.06));align-self:flex-end;color:#fff}
.choice-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:var(--white);cursor:pointer}
.choice-btn.primary{background:linear-gradient(90deg,var(--primary-3),var(--primary-2));color:#fff;border:none;box-shadow:var(--accent-shadow)}

.input{
  width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
  background:transparent;color:var(--white)
}

/* MOBILE */
@media (max-width:520px){
  .chat-panel{left:8px;right:8px;bottom:84px;max-height:86vh}
  .card{flex-direction:column;align-items:flex-start}
}
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center}

</style>
</head>
<body>

<!-- ============================================= -->
<!-- ============= TELA DE CARREGAMENTO =========== -->
<!-- ============================================= -->
<div id="loadingScreen">
  <div id="loadingLogo">
    <img src="https://i.imgur.com/3YB9EVh.jpeg">
  </div>
  <div class="spinner"></div>
  <div class="loadingText">Carregando lista...</div>
</div>

<!-- ============================================= -->
<!-- ==================== HEADER ================== -->
<!-- ============================================= -->
<div class="header">
  <div class="brand">
    <div class="logo"><img src="https://i.imgur.com/3YB9EVh.jpeg" alt="ADENE logo"></div>
    <div>
      <div class="title">ADENE ‚Äî Vila Tiradentes</div>
      <div class="subtitle small">Lista para o Caf√© da Comunh√£o</div>
    </div>
  </div>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <button id="refreshBtn" class="btn-small">Atualizar</button>
  </div>
</div>

<!-- ============================================= -->
<!-- ==================== LISTA =================== -->
<!-- ============================================= -->

<div class="main container" role="main">
  <div>
    <div style="display:flex;justify-content:space-between;align-items:end">
      <div>
        <div class="section-title">Itens da lista</div>
        <div class="small">Toque no bot√£o do assistente para reservar via chat</div>
      </div>
    </div>

    <div id="listArea" style="margin-top:12px">
      <!-- cards -->
    </div>
  </div>
</div>

<!-- ============================================= -->
<!-- =================== BOT BUTTON =============== -->
<!-- ============================================= -->
<div id="botBtn" class="bot-btn" title="Ajudante do Caf√©">üí¨</div>

<!-- ============================================= -->
<!-- =================== CHAT PANEL =============== -->
<!-- ============================================= -->
<div id="chatPanel" class="chat-panel hidden" aria-hidden="true">
  <div class="chat-header">
    <div style="font-weight:800">Ajudante ‚Äî Caf√© da Comunh√£o</div>
    <div style="font-size:13px;color:var(--muted)">Toque fora para fechar</div>
  </div>

  <div id="chatBody" class="chat-body"></div>

  <div class="chat-footer">
    <input id="chatInput" class="input" type="text" placeholder="Escreva..." aria-label="mensagem">
    <button id="chatSend" class="btn-small">Enviar</button>
  </div>
</div>

<script>
/* ---------------------------------------------- */
/*  CONFIG  */
/* ---------------------------------------------- */

const API_URL = "https://script.google.com/macros/s/AKfycbz7ZYVvchooVf82_88VF3bbUWlnlFKiK-09-y17KKLf20I1avsxpHjVHxDCu6NEmoX0/exec";

let listaGlobal = [];
const chatPanel = document.getElementById('chatPanel');
const botBtn = document.getElementById('botBtn');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const listArea = document.getElementById('listArea');
const refreshBtn = document.getElementById('refreshBtn');

/* ====== LOADING ====== */
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 1600);
});

/* ---------------------------------------------- */
/*  EVENTOS  */
/* ---------------------------------------------- */
botBtn.addEventListener('click', openChat);
refreshBtn.addEventListener('click', carregarLista);
document.addEventListener('click', (e) => {
  if (!chatPanel.classList.contains('hidden')) {
    const inside = chatPanel.contains(e.target) || botBtn.contains(e.target);
    if (!inside) closeChat();
  }
});

/* ---------------------------------------------- */
/*  UI HELPERS */
/* ---------------------------------------------- */
function appendBot(msg, html=false) {
  const m = document.createElement('div');
  m.className = 'msg bot';
  m.innerHTML = html ? msg : escapeHtml(msg);
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function appendUser(msg) {
  const m = document.createElement('div');
  m.className = 'msg user';
  m.textContent = msg;
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* ---------------------------------------------- */
/*  GET LISTA DO SHEET */
/* ---------------------------------------------- */
async function carregarLista() {
  try {
    const res = await fetch(API_URL);
    const dados = await res.json();
    listaGlobal = dados;
    renderListCards(dados);
  } catch (err) {
    listArea.innerHTML = '<div class="small">Erro ao carregar lista.</div>';
  }
}

/* ---------------------------------------------- */
/*  RENDER CARDS */
/* ---------------------------------------------- */
function renderListCards(dados) {
  listArea.innerHTML = '';
  if (!dados || dados.length === 0) {
    listArea.innerHTML = '<div class="small">Nenhum item encontrado.</div>';
    return;
  }

  dados.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const qty = item.quantidade ? `<div class="qty">${escapeHtml(item.quantidade)}</div>` : '';
    card.innerHTML = `
      <div class="left">
        <div class="item">${escapeHtml(item.item)}</div>
        ${qty}
      </div>
      <div style="text-align:right;min-width:140px">
        <div class="small">Respons√°vel</div>
        <div class="who">${escapeHtml(item.responsavel || '‚Äî Vago ‚Äî')}</div>
        ${
          !item.responsavel 
          ? `<div style="margin-top:8px"><button class="btn-small" onclick="startFlow_chooseExisting('${escapeAttr(item.item)}','${escapeAttr(item.quantidade||'')}')">Reservar</button></div>` 
          : ''
        }
      </div>
    `;
    listArea.appendChild(card);
  });
}

/* ---------------------------------------------- */
/*  BOT */
/* ---------------------------------------------- */
function openChat() {
  chatPanel.classList.remove('hidden');
  chatBody.innerHTML = '';
  appendBot('Ol√°! Eu sou o assistente do Caf√© da Comunh√£o. Como deseja proceder?');
  appendBot(`
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="choice-btn primary" onclick="choice_list()">Escolher item</button>
      <button class="choice-btn" onclick="choice_add()">Adicionar novo item</button>
    </div>
  `, true);
  chatInput.focus();
}

function closeChat() {
  chatPanel.classList.add('hidden');
}

/* ---------------- SELECIONAR ITEM EXISTENTE ---------------- */
function choice_list() {
  appendUser('Escolher item da lista');

  const vagos = listaGlobal.filter(i => !i.responsavel);

  if (vagos.length === 0) {
    appendBot('Nenhum item vago no momento.');
    appendBot(`<button class="choice-btn primary" onclick="choice_add()">Adicionar novo item</button>`, true);
    return;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">';
  vagos.forEach(v => {
    const label = v.quantidade ? `${v.item} ‚Äî ${v.quantidade}` : v.item;
    html += `<button class="choice-btn" onclick="startFlow_chooseExisting('${escapeAttr(v.item)}','${escapeAttr(v.quantidade||'')}')">${escapeHtml(label)}</button>`;
  });
  html += "</div>";

  appendBot('Selecione um item:', true);
  appendBot(html, true);
}

window.startFlow_chooseExisting = function(item, quantidade) {
  if (chatPanel.classList.contains('hidden')) openChat();
  appendUser(`Reservar: ${item} ${quantidade ? '‚Äî '+quantidade : ''}`);
  state.selected = { item, quantidade };

  appendBot(`Qual o seu nome para registrar?`);
  state.current = "confirm_name_for_existing";
}

/* ---------------- ADICIONAR ITEM NOVO ---------------- */
function choice_add() {
  appendUser('Adicionar novo item');
  appendBot('Qual o nome do item?');
  state.current = "add_item";
  chatInput.focus();
}

/* ---------------------------------------------- */
/* CONTROLE DO FLUXO */
/* ---------------------------------------------- */
const state = { current: null, selected: null };

chatSend.addEventListener('click', handleSend);
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSend(); });

function handleSend() {
  const txt = chatInput.value.trim();
  if (!txt) return;
  appendUser(txt);
  chatInput.value = '';

  if (state.current === "add_item") {
    state.new = { item: txt };
    appendBot("Quantidade? (Ex: 2 unidades)");
    state.current = "add_qty";
    return;
  }

  if (state.current === "add_qty") {
    state.new.quantidade = txt;
    appendBot("Seu nome:");
    state.current = "add_name";
    return;
  }

  if (state.current === "add_name") {
    state.new.responsavel = txt;
    appendBot("Adicionando item...");
    addNewItem(state.new.item, state.new.quantidade, state.new.responsavel);
    state.current = null;
    return;
  }

  if (state.current === "confirm_name_for_existing") {
    appendBot('Registrando...');
    assumeExistingItem(state.selected.item, state.selected.quantidade, txt);
    state.current = null;
    return;
  }

  appendBot("Escolha uma op√ß√£o acima para continuar.");
}

/* ---------------------------------------------- */
/*  FUN√á√ïES DE REDE */
/* ---------------------------------------------- */
async function assumeExistingItem(item, quantidade, nome) {
  try {
    const r = await fetch(API_URL, {
      method:'POST',
      body: JSON.stringify({ action:'assume', item, quantidade, responsavel:nome })
    });
    const j = await r.json();

    if (j.status === "ok") {
      appendBot("Item reservado com sucesso üôå");
      carregarLista();
      setTimeout(closeChat, 700);
    } else {
      appendBot("Erro ao reservar: "+(j.msg||'Falha'));
    }

  } catch(e) {
    appendBot("Erro de conex√£o.");
  }
}

async function addNewItem(item, quantidade, nome) {
  try {
    const r = await fetch(API_URL, {
      method:'POST',
      body: JSON.stringify({ action:'add', item, quantidade, responsavel:nome })
    });
    const j = await r.json();

    if (j.status === "ok") {
      appendBot("Item adicionado com sucesso üôå");
      carregarLista();
      setTimeout(closeChat, 900);
    } else {
      appendBot("Erro ao adicionar.");
    }

  } catch(e) {
    appendBot("Erro de conex√£o.");
  }
}

/* Escape */
function escapeHtml(str){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
function escapeAttr(str){ return (str||"").replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* Carregar lista no in√≠cio */
carregarLista();

</script>
</body>
</html>
