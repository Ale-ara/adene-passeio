<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADENE â€¢ Lista CafÃ© da ComunhÃ£o</title>

<style>
/* ============================================= */
/* ================ TEMA GLOBAL ================= */
/* ============================================= */
:root{
  --bg:#070707;
  --card:#0f0f10;
  --primary:#025E15;
  --primary-2:#038A28;
  --primary-3:#04A634;
  --muted:#9aa29a;
  --white:#ffffff;
  --glass: rgba(255,255,255,0.03);
  --accent-shadow: 0 18px 60px rgba(2,94,21,0.12);
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--white);
  -webkit-font-smoothing:antialiased;
}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* ============================================= */
/* ================ LOADING SCREEN ============= */
/* ============================================= */
#loadingScreen {
  position: fixed;
  inset:0;
  background:#000000e6;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:20px;
  z-index:3000;
  animation: fadeOut 0.8s ease 1.2s forwards;
}

#loadingLogo {
  width:95px;
  height:95px;
  border-radius:14px;
  overflow:hidden;
  border:2px solid var(--primary-3);
  box-shadow:0 0 25px rgba(2,94,21,0.45);
}

#loadingLogo img {
  width:100%; height:100%; object-fit:cover;
}

.loadingText {
  color:var(--primary-3);
  font-size:18px;
  font-weight:600;
}

.spinner {
  width:48px;
  height:48px;
  border:4px solid #ffffff18;
  border-top:4px solid var(--primary-3);
  border-radius:50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform:rotate(360deg); }
}

@keyframes fadeOut {
  to {
    opacity:0;
    visibility:hidden;
  }
}

/* ============================================= */
/* ================= HEADER ==================== */
/* ============================================= */
.header {
  position:fixed;left:0;right:0;top:0;height:76px;
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  background:linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.30));
  border-bottom:1px solid rgba(255,255,255,0.02);
  z-index:1000;
}
.brand {
  display:flex;gap:12px;align-items:center;
}
.brand .logo{
  width:56px;height:56px;border-radius:10px;background:#000;display:flex;align-items:center;justify-content:center;
  overflow:hidden;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 8px 30px rgba(0,0,0,0.6)
}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.header .title{font-size:16px;font-weight:700}
.header .subtitle{font-size:12px;color:var(--muted)}

.main {padding-top:98px;padding-left:12px;padding-right:12px}

/* ============================================= */
/* ================ CARD LIST ================== */
/* ============================================= */

.section-title{font-weight:700;margin:18px 0 8px 0;color:var(--primary-3);font-size:14px}
.small{font-size:12px;color:var(--muted)}

.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:12px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);
  display:flex;justify-content:space-between;align-items:center;gap:12px;
}
.card .left{display:flex;flex-direction:column;gap:6px;min-width:0}
.card .item{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card .qty{color:var(--muted);font-size:13px}
.card .who{color:var(--primary-3);font-weight:700}
.btn-small{
  background: linear-gradient(90deg,var(--primary),var(--primary-2));
  color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--accent-shadow)
}

/* ============================================= */
/* ================ BOT BUTTON ================= */
/* ============================================= */
.bot-btn{
  position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:999px;
  background:linear-gradient(90deg,var(--primary-3),var(--primary-2));
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--accent-shadow);z-index:2000;font-weight:900;color:#fff;font-size:22px;cursor:pointer;
  border:1px solid rgba(255,255,255,0.04);
}

/* ============================================= */
/* ========= CHAT FULLSCREEN COM BLUR ========== */
/* ============================================= */
.chat-panel{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index:2500;
  display:flex;
  flex-direction:column;
  padding-top:20px;
}
.chat-panel.hidden{display:none}

.chat-header{
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.chat-header-title{
  font-size:18px;
  font-weight:700;
}
.close-btn{
  font-size:24px;
  font-weight:900;
  cursor:pointer;
  padding:6px 12px;
  border-radius:8px;
  background:#ffffff15;
  color:white;
}

.chat-body{
  padding:16px;
  overflow:auto;
  flex:1;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.msg{
  max-width:85%;
  padding:12px 14px;
  border-radius:12px;
}
.msg.bot{
  background:#ffffff12;
  color:white;
}
.msg.user{
  align-self:flex-end;
  background:#04A63422;
  color:white;
}

.chat-footer{
  padding:14px;
  display:flex;
  gap:10px;
}
.input{
  flex:1;
  padding:12px;
  border-radius:12px;
  background:#ffffff10;
  border:1px solid #ffffff22;
  color:white;
}
.btn-small{
  padding:12px 18px !important;
}

/* END CSS */
</style>
</head>
<body>

<!-- ============================================= -->
<!-- ============= TELA DE CARREGAMENTO =========== -->
<!-- ============================================= -->
<div id="loadingScreen">
  <div id="loadingLogo">
    <img src="https://i.imgur.com/3YB9EVh.jpeg">
  </div>
  <div class="spinner"></div>
  <div class="loadingText">Carregando lista...</div>
</div>

<!-- ============================================= -->
<!-- ==================== HEADER ================== -->
<!-- ============================================= -->
<div class="header">
  <div class="brand">
    <div class="logo"><img src="https://i.imgur.com/3YB9EVh.jpeg"></div>
    <div>
      <div class="title">ADENE â€” Vila Tiradentes</div>
      <div class="subtitle small">Lista para o CafÃ© da ComunhÃ£o</div>
    </div>
  </div>
  <button id="refreshBtn" class="btn-small">Atualizar</button>
</div>

<!-- ============================================= -->
<!-- ==================== LISTA =================== -->
<!-- ============================================= -->
<div class="main container" role="main">
  <div>
    <div style="display:flex;justify-content:space-between;align-items:end">
      <div>
        <div class="section-title">Itens da lista</div>
        <div class="small">Toque no botÃ£o do assistente para reservar</div>
      </div>
    </div>

    <div id="listArea" style="margin-top:12px"></div>
  </div>
</div>

<!-- ============================================= -->
<!-- ================= BOT BUTTON ================= -->
<!-- ============================================= -->
<div id="botBtn" class="bot-btn">ðŸ’¬</div>

<!-- ============================================= -->
<!-- ================== CHAT FULLSCREEN ========= -->
<!-- ============================================= -->
<div id="chatPanel" class="chat-panel hidden">

  <div class="chat-header">
    <div class="chat-header-title">Ajudante â€” CafÃ© da ComunhÃ£o</div>
    <div class="close-btn" onclick="closeChat()">Ã—</div>
  </div>

  <div id="chatBody" class="chat-body"></div>

  <div class="chat-footer">
    <input id="chatInput" class="input" type="text" placeholder="Digite..." />
    <button id="chatSend" class="btn-small">Enviar</button>
  </div>

</div>

<script>
/* ========================================================= */
/*  SCRIPT (SEU SCRIPT FOI MANTIDO, APENAS PEQUENOS AJUSTES)  */
/* ========================================================= */

const API_URL =
  "https://script.google.com/macros/s/AKfycbz7ZYVvchooVf82_88VF3bbUWlnlFKiK-09-y17KKLf20I1avsxpHjVHxDCu6NEmoX0/exec";

let listaGlobal = [];

const chatPanel = document.getElementById("chatPanel");
const chatBody = document.getElementById("chatBody");
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");
const botBtn = document.getElementById("botBtn");
const refreshBtn = document.getElementById("refreshBtn");
const listArea = document.getElementById("listArea");

const state = { current: null, selected: null };

window.addEventListener("load", () => {
  setTimeout(() => {
    document.getElementById("loadingScreen").style.display = "none";
  }, 1600);
});

botBtn.addEventListener("click", openChat);

/* ====================== CHAT UI ====================== */
function openChat() {
  chatPanel.classList.remove("hidden");
  chatBody.innerHTML = "";

  appendBot(
    "OlÃ¡! Eu sou o assistente do CafÃ© da ComunhÃ£o. Como deseja continuar?"
  );

  appendBot(
    `
    <button class="choice-btn primary" onclick="choice_list()">Escolher item</button>
    <button class="choice-btn" onclick="choice_add()">Adicionar item novo</button>
  `,
    true
  );

  chatInput.focus();
}

function closeChat() {
  chatPanel.classList.add("hidden");
}

/* ========== mensagens ========== */
function appendBot(msg, html = false) {
  const m = document.createElement("div");
  m.className = "msg bot";
  m.innerHTML = html ? msg : msg;
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function appendUser(msg) {
  const m = document.createElement("div");
  m.className = "msg user";
  m.textContent = msg;
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* ====================== CARREGAR LISTA ===================== */
async function carregarLista() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    listaGlobal = data;
    renderListCards(data);
  } catch (err) {
    listArea.innerHTML = "<div class='small'>Erro ao carregar.</div>";
  }
}

refreshBtn.addEventListener("click", carregarLista);

/* ====================== CARDS ===================== */

function renderListCards(dados) {
  listArea.innerHTML = "";

  if (!dados.length) {
    listArea.innerHTML = "<div class='small'>Nenhum item encontrado.</div>";
    return;
  }

  dados.forEach((item) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="left">
        <div class="item">${item.item}</div>
        ${item.quantidade ? `<div class='qty'>${item.quantidade}</div>` : ""}
      </div>

      <div style="text-align:right;min-width:140px">
        <div class="small">ResponsÃ¡vel</div>
        <div class="who">${item.responsavel || "â€” Vago â€”"}</div>

        ${
          !item.responsavel
            ? `<button class="btn-small" onclick="startFlow_chooseExisting('${item.item}','${item.quantidade || ""}')">Reservar</button>`
            : ""
        }
      </div>
    `;

    listArea.appendChild(card);
  });
}

/* ====================== FLUXO RESERVAR ===================== */
function choice_list() {
  appendUser("Escolher item da lista");

  const vagas = listaGlobal.filter((i) => !i.responsavel);

  if (!vagas.length) {
    appendBot("Nenhum item vago. Deseja adicionar novo item?");
    return;
  }

  let html = "";
  vagas.forEach((v) => {
    html += `<button class="choice-btn" onclick="startFlow_chooseExisting('${v.item}','${v.quantidade || ""}')">${v.item} ${
      v.quantidade ? " â€” " + v.quantidade : ""
    }</button>`;
  });

  appendBot("Selecione um item:");
  appendBot(html, true);
}

/* FULLSCREEN + ABERTURA DIRETA */
window.startFlow_chooseExisting = function (item, quantidade) {
  chatPanel.classList.remove("hidden");

  chatBody.innerHTML = "";

  appendBot("VocÃª escolheu:");
  appendBot(`<strong>${item} ${
    quantidade ? " â€” " + quantidade : ""
  }</strong>`, true);

  state.selected = { item, quantidade };

  appendBot("Qual o seu nome?");
  state.current = "confirm_name_for_existing";
  chatInput.focus();
};

/* ====================== FLUXO ADICIONAR NOVO ITEM ===================== */

function choice_add() {
  appendUser("Adicionar novo item");
  appendBot("Qual o item?");
  state.current = "add_item";
  chatInput.focus();
}

/* ====================== ENVIO DE MENSAGENS ===================== */

chatSend.addEventListener("click", handleSend);
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleSend();
});

function handleSend() {
  const txt = chatInput.value.trim();
  if (!txt) return;
  appendUser(txt);
  chatInput.value = "";

  if (state.current === "add_item") {
    state.new = { item: txt };
    appendBot("Quantidade?");
    state.current = "add_qty";
    return;
  }

  if (state.current === "add_qty") {
    state.new.quantidade = txt;
    appendBot("Seu nome:");
    state.current = "add_name";
    return;
  }

  if (state.current === "add_name") {
    state.new.responsavel = txt;
    appendBot("Adicionando...");
    addNewItem(state.new.item, state.new.quantidade, state.new.responsavel);
    state.current = null;
    return;
  }

  if (state.current === "confirm_name_for_existing") {
    assumeExistingItem(state.selected.item, state.selected.quantidade, txt);
    state.current = null;
    return;
  }
}

/* ====================== API FUNCTIONS ===================== */

async function assumeExistingItem(item, quantidade, nome) {
  appendBot("Registrando...");

  const r = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "assume",
      item,
      quantidade,
      responsavel: nome,
    }),
  });

  const j = await r.json();

  if (j.status === "ok") {
    appendBot("Item reservado com sucesso ðŸ™Œ");
    carregarLista();
    setTimeout(closeChat, 1000);
  } else {
    appendBot("Erro ao reservar.");
  }
}

async function addNewItem(item, quantidade, nome) {
  appendBot("Enviando...");

  const r = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      item,
      quantidade,
      responsavel: nome,
    }),
  });

  const j = await r.json();

  if (j.status === "ok") {
    appendBot("Item adicionado ðŸ™Œ");
    carregarLista();
    setTimeout(closeChat, 900);
  } else {
    appendBot("Erro ao adicionar.");
  }
}

/* INICIAR */
carregarLista();

</script>
</body>
</html>
