
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADENE â€¢ Lista CafÃ© da ComunhÃ£o</title>
<link rel="icon" href="https://i.imgur.com/3YB9EVh.jpeg" />

<style>
:root{
  --bg:#025E15;
  --card:#083e10;
  --primary:#025E15;
  --primary-2:#038A28;
  --primary-3:#04A634;
  --muted:#dfefe0;
  --white:#ffffff;
  --glass: rgba(255,255,255,0.03);
  --accent-shadow: 0 18px 60px rgba(2,94,21,0.18);
}

/* Reset & base */
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* Header */
.header {position:fixed;left:0;right:0;top:0;height:76px;display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.06));border-bottom:1px solid rgba(255,255,255,0.02);z-index:1000;}
.brand {display:flex;gap:12px;align-items:center;}
.brand .logo{width:56px;height:56px;border-radius:10px;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.header .title{font-size:16px;font-weight:700}
.header .subtitle{font-size:12px;color:var(--muted)}

/* Main */
.main {padding-top:98px;padding-left:12px;padding-right:12px}

/* Section title */
.section-title{font-weight:700;margin:18px 0 8px 0;color:#e9f7ee;font-size:14px}
.small{font-size:12px;color:var(--muted)}

/* Cards */
.card {background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center;gap:12px;}
.card .left{display:flex;flex-direction:column;gap:6px;min-width:0}
.card .item{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card .qty{color:var(--muted);font-size:13px}
.card .who{color:#e9f7ee;font-weight:700}
.btn-small{background: linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--accent-shadow)}

/* Bot button */
.bot-btn{position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:999px;background:linear-gradient(90deg,#048a2b,#03722a);display:flex;align-items:center;justify-content:center;box-shadow:var(--accent-shadow);z-index:2000;font-weight:900;color:#fff;font-size:22px;cursor:pointer;border:1px solid rgba(255,255,255,0.04);}

/* Chat fullscreen with blur */
.chat-panel{position:fixed;inset:0;background:rgba(0,0,0,0.28);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(12px);z-index:2500;display:flex;flex-direction:column;padding-top:20px;}
.chat-panel.hidden{display:none;}
.chat-header{padding:16px;display:flex;justify-content:space-between;align-items:center;}
.chat-header-title{font-size:18px;font-weight:700;}
.close-btn{font-size:24px;font-weight:900;cursor:pointer;padding:6px 12px;border-radius:8px;background:rgba(255,255,255,0.06);color:white;border:1px solid rgba(255,255,255,0.04)}

/* Chat body and messages */
.chat-body{padding:16px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:12px;}
.msg{max-width:85%;padding:12px 14px;border-radius:12px;}
.msg.bot{background:rgba(255,255,255,0.06);color:white;}
.msg.user{align-self:flex-end;background:rgba(4,166,52,0.12);color:white;}

/* Chat footer */
.chat-footer{padding:14px;display:flex;gap:10px;}
.input{flex:1;padding:12px;border-radius:12px;background:#ffffff10;border:1px solid #ffffff22;color:white;outline:none;}
.btn-send{padding:12px 18px;border-radius:12px;background:linear-gradient(90deg,#048a2b,#03722a);border:none;color:#fff;font-weight:800;cursor:pointer}

/* Loading top thin bar (YouTube/iPhone style) */
#loadingScreen {position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:12px;background:linear-gradient(180deg, rgba(2,94,21,0.95), rgba(2,94,21,0.85));z-index:5000;}
#loadingTop {width:100%;height:4px;background:transparent;position:relative;overflow:hidden;}
#loadingProgress {position:absolute;left:0;top:0;height:4px;width:1%;background:linear-gradient(90deg,#048a2b,#03722a);transition:width 300ms linear;}
#loadingBox {margin-top:36px;display:flex;flex-direction:column;align-items:center;gap:12px;color:#e9f7ee;}
#loadingLogo {width:84px;height:84px;border-radius:12px;overflow:hidden;border:2px solid var(--primary-3);box-shadow:0 0 20px rgba(2,94,21,0.35);}
#loadingLogo img{width:100%;height:100%;object-fit:cover}
.loading-label{font-weight:700;color:#e9f7ee;font-size:15px}
.loading-sub{font-size:13px;color:var(--muted)}

/* Media queries */
@media (max-width: 540px){
  .brand .logo{width:48px;height:48px}
  .header .title{font-size:15px}
  .chat-header-title{font-size:16px}
  .btn-send{padding:10px 14px}
  #loadingBox{margin-top:28px}
}

/* smaller phones */
@media (max-width:360px){
  .bot-btn{width:56px;height:56px;font-size:20px}
  .header .title{font-size:14px}
  .loading-label{font-size:14px}
  .chat-footer{padding:10px}
  .input{padding:10px}
}

/* helper hidden */
.hidden{display:none}
</style>
</head>
<body>

<!-- Loading screen (top thin progress + center logo) -->
<div id="loadingScreen" aria-hidden="false">
  <div id="loadingTop"><div id="loadingProgress"></div></div>
  <div id="loadingBox">
    <div id="loadingLogo"><img src="https://i.imgur.com/3YB9EVh.jpeg" alt="ADENE"></div>
    <div class="loading-label">Carregando lista...</div>
    <div class="loading-sub" style="color:#e6f6ea">Aguarde â€” puxando informaÃ§Ãµes do CafÃ©</div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="brand">
    <div class="logo"><img src="https://i.imgur.com/3YB9EVh.jpeg" alt="ADENE logo"></div>
    <div>
      <div class="title">ADENE â€” Vila Tiradentes</div>
      <div class="subtitle small">Lista para o CafÃ© da ComunhÃ£o</div>
    </div>
  </div>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <button id="refreshBtn" class="btn-small">Atualizar</button>
  </div>
</div>

<!-- Main list area -->
<div class="main container" role="main">
  <div>
    <div style="display:flex;justify-content:space-between;align-items:end">
      <div>
        <div class="section-title">Itens da lista</div>
        <div class="small">Toque em "Reservar" para iniciar</div>
      </div>
    </div>
    <div id="listArea" style="margin-top:12px"></div>
  </div>
</div>

<!-- Bot button -->
<div id="botBtn" class="bot-btn" title="Ajudante">ðŸ’¬</div>

<!-- Chat fullscreen panel -->
<div id="chatPanel" class="chat-panel hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="chat-header">
    <div class="chat-header-title">Ajudante â€” CafÃ© da ComunhÃ£o</div>
    <div class="close-btn" id="closeChatBtn" title="Fechar">Ã—</div>
  </div>
  <div id="chatBody" class="chat-body" aria-live="polite"></div>
  <div class="chat-footer">
    <input id="chatInput" class="input" type="text" placeholder="Digite seu nome..." aria-label="campo de texto">
    <button id="chatSend" class="btn-send">Enviar</button>
  </div>
</div>

<script>
/* Configuration */
const API_URL = "https://script.google.com/macros/s/AKfycbz7ZYVvchooVf82_88VF3bbUWlnlFKiK-09-y17KKLf20I1avsxpHjVHxDCu6NEmoX0/exec";
let listaGlobal = [];
const loadingScreen = document.getElementById('loadingScreen');
const loadingProgress = document.getElementById('loadingProgress');
const listArea = document.getElementById('listArea');
const botBtn = document.getElementById('botBtn');
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const closeChatBtn = document.getElementById('closeChatBtn');
const refreshBtn = document.getElementById('refreshBtn');

/* Fake-progress controller (Option 2 behavior): */
let fakeProgress = 1;
let fakeInterval = null;
function startFakeProgress() {
  fakeProgress = 1;
  loadingProgress.style.width = '1%';
  if (fakeInterval) clearInterval(fakeInterval);
  // progress speed: fast at start, slower later
  fakeInterval = setInterval(() => {
    // increment depending on current value
    if (fakeProgress < 60) fakeProgress += Math.random()*6 + 1; // fast
    else if (fakeProgress < 85) fakeProgress += Math.random()*3 + 0.5; // medium
    else fakeProgress += Math.random()*1 + 0.1; // slow
    if (fakeProgress > 99) fakeProgress = 99; // never reach 100% until fetch finishes
    loadingProgress.style.width = Math.floor(fakeProgress) + '%';
  }, 220);
}

function finishFakeProgressThenHide() {
  if (fakeInterval) clearInterval(fakeInterval);
  // jump quickly to 100% and hide
  loadingProgress.style.width = '100%';
  setTimeout(() => {
    // fade out
    loadingScreen.style.transition = 'opacity .45s ease';
    loadingScreen.style.opacity = '0';
    setTimeout(()=> {
      loadingScreen.style.display = 'none';
      loadingScreen.setAttribute('aria-hidden','true');
    },480);
  }, 300);
}

/* Show loading and fetch list */
async function loadAndRenderList() {
  // show loading
  loadingScreen.style.display = 'flex';
  loadingScreen.style.opacity = '1';
  loadingScreen.setAttribute('aria-hidden','false');
  startFakeProgress();
  try {
    const res = await fetch(API_URL);
    const dados = await res.json();
    listaGlobal = dados;
    // ensure progress moves to near-complete then finish
    fakeProgress = 95;
    loadingProgress.style.width = '95%';
    // short delay to improve UX
    setTimeout(()=> {
      renderListCards(dados);
      finishFakeProgressThenHide();
    }, 300);
  } catch (err) {
    console.error(err);
    // show error then hide loading after short delay
    loadingProgress.style.width = '100%';
    setTimeout(()=> {
      loadingScreen.style.opacity = '0';
      setTimeout(()=> loadingScreen.style.display='none',450);
    },800);
    listArea.innerHTML = '<div class="small">Erro ao carregar lista. Verifique deploy do Apps Script.</div>';
  }
}

/* Render cards */
function renderListCards(dados) {
  listArea.innerHTML = '';
  if (!dados || dados.length===0) {
    listArea.innerHTML = '<div class="small">Nenhum item encontrado.</div>';
    return;
  }
  dados.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const qty = item.quantidade ? `<div class="qty">${escapeHtml(item.quantidade)}</div>` : '';
    card.innerHTML = `
      <div class="left">
        <div class="item">${escapeHtml(item.item)}</div>
        ${qty}
      </div>
      <div style="text-align:right;min-width:140px">
        <div class="small">ResponsÃ¡vel</div>
        <div class="who">${escapeHtml(item.responsavel || 'â€” Vago â€”')}</div>
        ${!item.responsavel ? '<div style="margin-top:8px"><button class="btn-small" data-item="'+escapeAttr(item.item)+'" data-qty="'+escapeAttr(item.quantidade||'')+'">Reservar</button></div>' : ''}
      </div>
    `;
    listArea.appendChild(card);
  });
  // attach click handlers to reserve buttons (delegated)
  document.querySelectorAll('.btn-small[data-item]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const it = btn.getAttribute('data-item');
      const q = btn.getAttribute('data-qty');
      startFlow_chooseExisting(it,q);
    });
  });
}

/* Chat behavior (fullscreen) */
function openChat() {
  chatPanel.classList.remove('hidden');
  chatPanel.setAttribute('aria-hidden','false');
  chatBody.innerHTML = '';
  appendBot('OlÃ¡! Eu sou o assistente do CafÃ© da ComunhÃ£o. Como deseja proceder?');
  appendBot('<div style="display:flex;gap:8px;margin-top:8px"><button class="choice-btn primary" onclick="choice_list()">Escolher item</button><button class="choice-btn" onclick="choice_add()">Adicionar novo item</button></div>', true);
  chatInput.placeholder = 'VocÃª pode escrever aqui...';
  chatInput.value='';
  chatInput.focus();
}

function closeChat() {
  chatPanel.classList.add('hidden');
  chatPanel.setAttribute('aria-hidden','true');
}

/* Append messages */
function appendBot(msg, html=false) {
  const m = document.createElement('div');
  m.className = 'msg bot';
  m.innerHTML = html ? msg : escapeHtml(msg);
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}
function appendUser(msg) {
  const m = document.createElement('div');
  m.className = 'msg user';
  m.textContent = msg;
  chatBody.appendChild(m);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* Choice handlers */
function choice_list() {
  appendUser('Escolher item da lista');
  const vagos = listaGlobal.filter(i => !i.responsavel);
  if (vagos.length === 0) {
    appendBot('No momento nÃ£o hÃ¡ itens vagos. Deseja adicionar um item novo?', false);
    appendBot('<div style="display:flex;gap:8px;margin-top:8px"><button class="choice-btn primary" onclick="choice_add()">Adicionar novo item</button></div>', true);
    return;
  }
  let html = '<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">';
  vagos.forEach(v => {
    const label = (v.quantidade ? (v.item + ' â€” ' + v.quantidade) : v.item);
    html += `<button class="choice-btn" onclick="startFlow_chooseExisting('${escapeAttr(v.item)}','${escapeAttr(v.quantidade||'')}')">${escapeHtml(label)}</button>`;
  });
  html += '</div>';
  appendBot('Selecione o item que deseja reservar:', true);
  appendBot(html, true);
}

function choice_add() {
  appendUser('Adicionar novo item');
  appendBot('Beleza â€” vou te pedir os dados do item novo. Qual o nome do item? (ex: Suco natural)');
  state.current = 'add_item';
  chatInput.focus();
}

/* Flow to choose existing item */
window.startFlow_chooseExisting = function(item, quantidade) {
  // open full chat panel
  openChat();
  appendUser('Reservar: ' + item + (quantidade ? ' â€” ' + quantidade : ''));
  state.selected = { item: item, quantidade: quantidade };
  appendBot('VocÃª escolheu: <strong>' + escapeHtml(item) + (quantidade ? ' â€” ' + escapeHtml(quantidade) : '') + '</strong>', true);
  appendBot('Qual o seu nome para eu registrar?', false);
  state.current = 'confirm_name_for_existing';
  chatInput.focus();
}

/* Flow state and send handling */
const state = { current: null, selected: null, new: null };
chatSend.addEventListener('click', handleSend);
chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });

function handleSend() {
  const txt = chatInput.value.trim();
  if (!txt) return;
  appendUser(txt);
  chatInput.value = '';

  if (state.current === 'add_item') {
    state.new = { item: txt };
    appendBot('Quantidade (ex: 2 unidades, 500g, 1/2):');
    state.current = 'add_qty';
    return;
  }
  if (state.current === 'add_qty') {
    state.new.quantidade = txt;
    appendBot('Ã“timo. Qual o seu nome?');
    state.current = 'add_name';
    return;
  }
  if (state.current === 'add_name') {
    state.new.responsavel = txt;
    appendBot('Enviando o item para a lista...');
    addNewItem(state.new.item, state.new.quantidade, state.new.responsavel);
    state.current = null;
    state.new = null;
    return;
  }
  if (state.current === 'confirm_name_for_existing') {
    const nome = txt;
    appendBot('Enviando reserva...');
    assumeExistingItem(state.selected.item, state.selected.quantidade, nome);
    state.current = null;
    state.selected = null;
    return;
  }

  appendBot('Para comeÃ§ar, escolha "Escolher item da lista" ou "Adicionar novo item" no menu.');
}

/* Network functions */
async function assumeExistingItem(item, quantidade, nome) {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'assume', item: item, quantidade: quantidade, responsavel: nome })
    });
    const json = await res.json();
    if (json.status === 'ok') {
      appendBot('Prontinho â€” item reservado com sucesso! Obrigado ðŸ™Œ');
      await loadAndRenderList();
      setTimeout(closeChat, 800);
    } else {
      appendBot('Ops â€” nÃ£o foi possÃ­vel reservar: ' + (json.msg || 'erro'));
      await loadAndRenderList();
    }
  } catch (err) {
    appendBot('Erro na comunicaÃ§Ã£o com o servidor. Tente novamente.');
    console.error(err);
  }
}

async function addNewItem(item, quantidade, nome) {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', item: item, quantidade: quantidade, responsavel: nome })
    });
    const json = await res.json();
    if (json.status === 'ok') {
      appendBot('Item adicionado com sucesso e sua contribuiÃ§Ã£o foi registrada. Obrigado ðŸ™Œ');
      await loadAndRenderList();
      setTimeout(closeChat, 900);
    } else {
      appendBot('NÃ£o foi possÃ­vel adicionar: ' + (json.msg || 'erro'));
    }
  } catch (err) {
    appendBot('Erro ao adicionar o item. Tente novamente.');
    console.error(err);
  }
}

/* Utility escapes */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function escapeAttr(s) { return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* Attach handlers */
botBtn.addEventListener('click', openChat);
closeChatBtn.addEventListener('click', closeChat);
refreshBtn.addEventListener('click', loadAndRenderList);

/* Initial load: wait for DOM then fetch */
window.addEventListener('load', ()=>{
  // small delay so styles settle
  setTimeout(()=> loadAndRenderList(), 120);
});

</script>
</body>
</html>
