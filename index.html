
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADENE â€¢ Lista CafÃ© da ComunhÃ£o</title>
<link rel="icon" href="https://i.imgur.com/3YB9EVh.jpeg" />

<style>
:root{
  --bg:#070707;
  --card:#0f0f10;
  --primary:#025E15;
  --primary-2:#038A28;
  --primary-3:#04A634;
  --muted:#9aa29a;
  --white:#ffffff;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased}

/* Loading */
#loadingOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.9);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:5000;transition:opacity .4s;
}
#loadingBarWrap{
  width:80%;height:4px;background:#333;border-radius:4px;overflow:hidden;
}
#loadingBar{height:100%;width:1%;background:#04A634;transition:width .2s}

/* Buttons style C */
.btn-small,.choice-btn,.choice-btn.primary,#chatSend,.bot-btn{
  background:#0c0c0c!important;
  border:2px solid var(--primary)!important;
  color:#fff!important;
  border-radius:10px!important;
  cursor:pointer;
}

/* header */
.header {
  position:fixed;left:0;right:0;top:0;height:76px;
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  background:linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.30));
  z-index:1000;
}
.brand{display:flex;gap:12px;align-items:center}
.brand .logo{
  width:56px;height:56px;border-radius:10px;background:#000;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.brand .logo img{width:100%;height:100%;object-fit:cover}

.main{padding-top:98px;padding-left:12px;padding-right:12px}

.section-title{font-weight:700;margin:18px 0 8px 0;color:var(--primary-3);font-size:14px}
.small{font-size:12px;color:var(--muted)}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:12px;margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.06);
  display:flex;justify-content:space-between;align-items:center;gap:12px;
}
.card .left{display:flex;flex-direction:column;gap:6px;min-width:0}

.bot-btn{
  position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  z-index:2000;font-weight:900;font-size:22px;
}

.chat-panel{
  position:fixed;left:0;right:0;bottom:0;top:0;
  background:rgba(0,0,0,0.92);
  backdrop-filter:blur(6px);
  z-index:3000;
  display:none;flex-direction:column;
}
.chat-header{
  padding:16px;font-size:18px;font-weight:700;
  display:flex;justify-content:space-between;
}
.chat-body{padding:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px}
.msg{padding:10px 12px;border-radius:12px;max-width:80%}
.msg.bot{background:rgba(255,255,255,0.06)}
.msg.user{background:rgba(4,166,52,0.18);margin-left:auto}
.chat-footer{padding:12px;display:flex;gap:8px}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
.hidden{display:none!important}
</style>
</head>

<body>
<div id="loadingOverlay">
  <div style="color:white;margin-bottom:12px;font-size:18px">Carregandoâ€¦</div>
  <div id="loadingBarWrap"><div id="loadingBar"></div></div>
</div>

<div class="header">
  <div class="brand">
    <div class="logo"><img src="https://i.imgur.com/3YB9EVh.jpeg"></div>
    <div>
      <div class="title">ADENE â€” Vila Tiradentes</div>
      <div class="subtitle small">Lista para o CafÃ© da ComunhÃ£o</div>
    </div>
  </div>
  <button id="refreshBtn" class="btn-small">Atualizar</button>
</div>

<div class="main container">
  <div class="section-title">Itens da lista</div>
  <div class="small">Toque no botÃ£o do assistente para reservar via chat</div>
  <div id="listArea" style="margin-top:12px"></div>
</div>

<div id="botBtn" class="bot-btn">ðŸ’¬</div>

<div id="chatPanel" class="chat-panel">
  <div class="chat-header">
    <span>Ajudante â€” CafÃ© da ComunhÃ£o</span>
    <button id="closeChat" class="btn-small" style="padding:4px 10px">X</button>
  </div>
  <div id="chatBody" class="chat-body"></div>
  <div class="chat-footer">
    <input id="chatInput" class="input" placeholder="Escreva...">
    <button id="chatSend" class="btn-small">Enviar</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz7ZYVvchooVf82_88VF3bbUWlnlFKiK-09-y17KKLf20I1avsxpHjVHxDCu6NEmoX0/exec";
let listaGlobal = [];

const loading = document.getElementById("loadingOverlay");
const bar = document.getElementById("loadingBar");

function startLoading(){
  loading.style.display="flex";
  let p = 1;
  bar.style.width = p+"%";
  let interval = setInterval(()=>{
    p += Math.random()*6;
    if(p >= 95) p = 95;
    bar.style.width = p+"%";
  },150);
  return interval;
}
function stopLoading(interval){
  clearInterval(interval);
  bar.style.width = "100%";
  setTimeout(()=>{
    loading.style.opacity="0";
    setTimeout(()=> loading.style.display="none",400);
  },200);
}

async function carregarLista(){
  let l = startLoading();
  try{
    const r = await fetch(API_URL);
    listaGlobal = await r.json();
    renderList();
  } catch(e){
    listArea.innerHTML = "<div class='small'>Erro ao carregar.</div>";
  }
  stopLoading(l);
}

function renderList(){
  listArea.innerHTML="";
  listaGlobal.forEach(i=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="left">
        <div class="item">${i.item}</div>
        <div class="qty">${i.quantidade||""}</div>
      </div>
      <div style="text-align:right;min-width:120px">
        <div class="small">ResponsÃ¡vel</div>
        <div class="who">${i.responsavel||"â€” Vago â€”"}</div>
        ${!i.responsavel ? `<button class="btn-small" onclick="reservar('${i.item}','${i.quantidade||""}')">Reservar</button>`:""}
      </div>`;
    listArea.appendChild(card);
  });
}

function appendBot(t){
  let m=document.createElement("div");
  m.className="msg bot";
  m.innerHTML=t;
  chatBody.appendChild(m);
  chatBody.scrollTop=chatBody.scrollHeight;
}
function appendUser(t){
  let m=document.createElement("div");
  m.className="msg user";
  m.textContent=t;
  chatBody.appendChild(m);
  chatBody.scrollTop=chatBody.scrollHeight;
}

const chatPanel=document.getElementById("chatPanel");
document.getElementById("closeChat").onclick=()=> chatPanel.style.display="none";

document.getElementById("botBtn").onclick=()=>{
  let l=startLoading();
  setTimeout(()=>{
    chatPanel.style.display="flex";
    chatBody.innerHTML="";
    appendBot("OlÃ¡! Como deseja proceder?");
    appendBot(`<button class='choice-btn' onclick='listarVagos()'>Escolher item da lista</button>
               <button class='choice-btn' onclick='novoItem()'>Adicionar novo item</button>`);
    stopLoading(l);
  },500);
};

let flow=null, selected={};

function reservar(item,q){
  chatPanel.style.display="flex";
  chatBody.innerHTML="";
  appendBot("VocÃª escolheu:<br><b>"+item+" "+q+"</b>");
  appendBot("Qual seu nome?");
  flow="reservar";
  selected={item,quantidade:q};
}

function listarVagos(){
  appendUser("Escolher item");
  let vagos = listaGlobal.filter(x=> !x.responsavel);
  if(!vagos.length){
    appendBot("Nenhum item vago.");
    return;
  }
  vagos.forEach(v=>{
    appendBot(`<button class='choice-btn' onclick="reservar('${v.item}','${v.quantidade||""}')">${v.item} ${v.quantidade||""}</button>`);
  });
}

function novoItem(){
  appendUser("Adicionar novo item");
  appendBot("Nome do item?");
  flow="novo_item";
  selected={};
}

document.getElementById("chatSend").onclick=sendMsg;
document.getElementById("chatInput").onkeydown=e=>{if(e.key==="Enter")sendMsg();};

async function sendMsg(){
  let txt = chatInput.value.trim();
  if(!txt)return;
  appendUser(txt);
  chatInput.value="";

  if(flow==="reservar"){
    let l=startLoading();
    await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"assume",item:selected.item,quantidade:selected.quantidade,responsavel:txt})});
    appendBot("Reserva feita! ðŸ™Œ");
    carregarLista();
    stopLoading(l);
    flow=null;
  }
  else if(flow==="novo_item"){
    selected.item=txt;
    appendBot("Quantidade?");
    flow="novo_qtd";
  }
  else if(flow==="novo_qtd"){
    selected.quantidade=txt;
    appendBot("Seu nome?");
    flow="novo_nome";
  }
  else if(flow==="novo_nome"){
    let l=startLoading();
    await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"add",item:selected.item,quantidade:selected.quantidade,responsavel:txt})});
    appendBot("Item adicionado! ðŸ™Œ");
    carregarLista();
    stopLoading(l);
    flow=null;
  }
}

carregarLista();
</script>
</body>
</html>
